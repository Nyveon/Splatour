<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>3DGSM Editor</title>
		<link rel="stylesheet" href="./css/style.css" />
		<link rel="stylesheet" href="./css/viewer.css" />
		<link rel="stylesheet" href="./css/editor.css" />
	</head>
	<body
		x-data="{
            world: null,
            previewing: false,
            axes: ['x', 'y', 'z'],
            defaultStep: 0.1,
            uploadModalVisible: false,
            formatCoordinate(vector, axis) {
                const value = vector[axis].toFixed(1)
                return (axis === 'x' ? '(' : '') + value + (axis === 'z' ? ')' : ', ')
            },
            handleModalSubmit(fileInput) {
                if (!fileInput || !fileInput.files) {
                    alert('File input not found.');
                    return;
                }

                const file = fileInput.files[0];

                if (!file) {
                    alert('Please select a JSON file');
                    return;
                }

                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        if (!e.target || !e.target.result) {
                            throw new Error('Invalid file data.');
                        }

                        successToast('JSON data uploaded');
                        const gsmap = GS3dMap.deserialize(e.target.result);
                        this.world = new GS3dViewer(gsmap, true);
                    } catch (error) {
                        alert('Invalid JSON file. '+ error);
                    }
                };

                this.previewing = true;
                reader.readAsText(file);
                this.uploadModalVisible = false;
            },
            createNewMap() {
                this.previewing = true;
                successToast('Map created');
                this.world = new GS3dViewer(new GS3dMap('New Map'), true);
            },
        }"
	>
		<header x-data>
			<div role="toolbar" x-data>
				<template x-if="world" x-data>
					<div
						class="text"
						id="map-name"
						x-data="{
                            editing: false,
                        }"
						@keyup.escape.window="editing = false"
					>
						<span x-text="world.gsmap.name" x-show="!editing"></span>
						<input
							type="text"
							x-show="editing"
							x-model="world.gsmap.name"
							@keyup.enter="editing = false"
							@keyup.escape="editing = false"
							:size="Math.max(world.gsmap.name.length - 3, 3)"
							maxlength="16"
						/>
						<button class="edit" @click="editing = !editing">
							<span x-feather="edit-3" x-show="!editing"></span>
							<span x-feather="check" x-show="editing"></span>
						</button>
					</div>
				</template>
				<div></div>

				<button class="action" @click="uploadModalVisible=true" x-show="!world">
					<span x-feather="upload"></span>Import
				</button>
				<button
					class="action"
					@click="copyToClipboard('map JSON', world.gsmap.serialize())"
					x-show="world"
				>
					<span x-feather="download"></span>Export
				</button>
				<button class="action" @click="createNewMap()" x-show="!world">
					<span x-feather="file-plus"></span>Create
				</button>
			</div>

			<div>Placeholder</div>
		</header>

		<div id="upload-modal" class="modal" x-show="uploadModalVisible">
			<div class="modal-content">
				<h2>Upload JSON File</h2>
				<input type="file" id="fileInput" accept=".json" x-ref="fileInput" />
				<br /><br />
				<button @click="handleModalSubmit($refs.fileInput)">Submit</button>
			</div>
		</div>

		<main x-data>
			<aside>
				<template x-if="world?.gsmap.scenes">
					<ul>
						<template x-for="scene in world.gsmap.scenes">
							<li
								class="splat-file"
								x-data="{
                                editing: false
                            }"
								x-init="
                                    $watch('scene', value => scene.updateContainer());
                                "
							>
								<div class="name-bar" x-data>
									<input
										type="text"
										x-show="editing"
										x-model="scene.name"
										@keyup.enter="editing = false"
										@keyup.escape="editing = false"
										:size="Math.max(scene.name.length - 3, 3)"
										maxlength="16"
									/>
									<span x-text="scene.name" x-show="!editing"></span>
									<button class="edit" @click="editing = !editing;">
										<span x-feather="sliders" x-show="!editing"></span>
										<span x-feather="check" x-show="editing"></span>
									</button>
								</div>
								<ul class="splat-details" :class="!editing || 'editing'">
									<li>
										<span x-feather="file"></span
										><span x-text="scene.filePath"></span>
									</li>
									<li>
										<div class="values">
											<span x-feather="maximize-2"></span>
											<div x-show="!editing">
												<template x-for="axis in axes" :key="axis"
													><span
														x-text="formatCoordinate(scene.scale, axis)"
													></span
												></template>
											</div>
										</div>
										<ul class="value-set" x-show="editing">
											<template x-for="axis in axes" :key="axis">
												<div class="editable-parameters">
													<label
														x-text="axis"
														class="axis"
														:class="axis"
														:for="axis + '-scale-' +scene.name"
													></label>

													<button
														class="stepper"
														@click="scene.scale[axis] -= defaultStep"
													>
														-
													</button>
													<input
														:id="axis + '-scale-' + scene.name"
														type="number"
														x-model.number="scene.scale[axis]"
														step="0.1"
													/>
													<button
														class="stepper"
														@click="scene.scale[axis] += defaultStep"
													>
														+
													</button>
												</div>
											</template>
										</ul>
									</li>
									<li>
										<div class="values">
											<span x-feather="move"></span>
											<div x-show="!editing">
												<template x-for="axis in axes" :key="axis"
													><span
														x-text="formatCoordinate(scene.position, axis)"
													></span
												></template>
											</div>
										</div>
										<ul class="value-set" x-show="editing">
											<template x-for="axis in axes" :key="axis">
												<div class="editable-parameters">
													<label
														x-text="axis"
														class="axis"
														:class="axis"
														:for="axis + '-position-' +scene.name"
													></label>

													<button
														class="stepper"
														@click="scene.position[axis] -= defaultStep"
													>
														-
													</button>
													<input
														:id="axis + '-position-' + scene.name"
														type="number"
														x-model.number="scene.position[axis]"
														step="0.1"
													/>
													<button
														class="stepper"
														@click="scene.position[axis] += defaultStep"
													>
														+
													</button>
												</div>
											</template>
										</ul>
									</li>
									<li>
										<div class="values">
											<span x-feather="rotate-cw"></span>
											<div x-show="!editing">
												<template x-for="axis in axes" :key="axis"
													><span
														x-text="formatCoordinate(scene.rotation, axis)"
													></span
												></template>
											</div>
										</div>
										<ul class="value-set" x-show="editing">
											<template x-for="axis in axes" :key="axis">
												<div class="editable-parameters">
													<label
														x-text="axis"
														class="axis"
														:class="axis"
														:for="axis + '-rotation-' +scene.name"
													></label>

													<div
														class="slider-container"
														x-data="{ showTooltip: false }"
													>
														<input
															:id="axis + '-rotation-' + scene.name"
															type="range"
															x-model.number="scene.rotation[axis]"
															min="0"
															max="6.3"
															step="0.01"
															@input="showTooltip = true"
															@change="showTooltip = false"
															@click.outside="showTooltip = false"
														/>

														<div
															x-show="showTooltip"
															class="slider-tooltip"
															x-text="scene.rotation[axis].toFixed(3)"
														></div>
													</div>
												</div>
											</template>
										</ul>
									</li>
									<li>
										<button
											class="danger"
											x-show="editing"
											@click="editing=false;world.gsmap.deleteGSScene(scene.sceneIndex);"
										>
											<span x-feather="trash-2"></span>Remove
										</button>
									</li>
								</ul>
							</li>
						</template>
                        <li id="new-splat">
                            <button><span x-feather="plus-circle"></span>New Scene</button>
                        </li>
					</ul>
				</template>
			</aside>

			<section id="preview">
                <div id="viewer" x-show="previewing"></div>

				<div class="info-box" x-show="!previewing">
					<i x-feather="eye"></i>Load or create a map to preview it
				</div>
			</section>
		</main>

		<script type="module" src="./js/main.ts"></script>
	</body>
</html>
